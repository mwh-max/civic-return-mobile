<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Civic Return</title>
    <meta
      name="description"
      content="Find your green space per resident in Kentucky."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f2e9;
        --bg-2: #e9dfc9;
        --ink: #21301f;
        --accent: #7f9b6a;
        --accent-ink: #f6f2e9;
        --card: #fffdf8;
        --muted: #65725f;
        --border: #e4ddcf;
        --focus: #3b6d3e;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Montserrat, system-ui, sans-serif;
        color: var(--ink);
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      }

      .container {
        max-width: 640px;
        margin: 0 auto;
        padding: 20px 16px 64px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px 20px;
        box-shadow: var(--shadow);
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 8px;
        justify-content: center;
        text-align: center;
      }

      .logo {
        width: 96px;
        height: 96px;
        border-radius: 12px;
        object-fit: contain;
        background: #e7e4d9;
      }
      .brand h1 {
        font-size: 28px;
        font-weight: 900;
        margin: 0;
      }

      .lead {
        text-align: center;
        margin: 12px 8px 24px;
      }
      .lead h2 {
        margin: 0 0 8px;
        font-size: 28px;
        line-height: 1.15;
        font-weight: 800;
      }
      .lead p {
        color: var(--muted);
        margin: 0;
      }

      .form {
        display: grid;
        gap: 14px;
        margin-top: 16px;
      }

      label {
        font-weight: 600;
      }

      select,
      button {
        width: 100%;
        font: inherit;
        border-radius: 12px;
        padding: 14px 12px;
        border: 1px solid var(--border);
        background: white;
      }

      select:focus,
      button:focus {
        outline: none;
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus) 35%, white);
        border-color: var(--focus);
      }

      .button {
        background: var(--accent);
        color: var(--accent-ink);
        border: none;
        font-weight: 700;
        letter-spacing: 0.3px;
        cursor: pointer;
      }

      .button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .rule {
        border: 0;
        height: 1px;
        background: var(--border);
        margin: 24px 0;
      }

      .result {
        display: none;
        margin-top: 12px;
        background: #f3f0e6;
        border: 1px dashed var(--border);
        padding: 16px;
        border-radius: 12px;
      }
      .result.show {
        display: block;
      }
      .result h3 {
        margin: 0 0 6px;
        font-size: 20px;
        font-weight: 800;
      }
      .metric {
        margin: 6px 0;
        font-size: 16px;
      }
      .metric span {
        font-weight: 700;
      }
      .note {
        color: var(--muted);
        font-size: 14px;
        margin-top: 6px;
      }

      footer {
        margin-top: 28px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card" aria-labelledby="title">
        <header>
          <img
            class="logo"
            src="assets/civic-return-logo.jpg"
            alt="Civic Return logo"
          />
          <div class="brand">
            <h1 id="title">CIVIC RETURN</h1>
          </div>
        </header>

        <div class="lead">
          <h2>Find Your Green Space</h2>
          <p>
            Select your county in Kentucky to calculate your share of public
            green space.
          </p>
        </div>

        <form class="form" id="form" novalidate>
          <label for="county">County</label>
          <select id="county" required>
            <option value="" selected>Select a county…</option>
            <option value="001">Adair</option>
            <option value="003">Allen</option>
            <option value="005">Anderson</option>
            <option value="007">Ballard</option>
            <option value="009">Barren</option>
            <option value="011">Bath</option>
            <option value="013">Bell</option>
            <option value="015">Boone</option>
            <option value="017">Bourbon</option>
            <option value="019">Boyd</option>
            <option value="021">Boyle</option>
            <option value="023">Bracken</option>
            <option value="025">Breathitt</option>
            <option value="027">Breckinridge</option>
            <option value="029">Bullitt</option>
            <option value="031">Butler</option>
            <option value="033">Caldwell</option>
            <option value="035">Calloway</option>
            <option value="037">Campbell</option>
            <option value="039">Carlisle</option>
            <option value="041">Carroll</option>
            <option value="043">Carter</option>
            <option value="045">Casey</option>
            <option value="047">Christian</option>
            <option value="049">Clark</option>
            <option value="051">Clay</option>
            <option value="053">Clinton</option>
            <option value="055">Crittenden</option>
            <option value="057">Cumberland</option>
            <option value="059">Daviess</option>
            <option value="061">Edmonson</option>
            <option value="063">Elliott</option>
            <option value="065">Estill</option>
            <option value="067">Fayette</option>
            <option value="069">Fleming</option>
            <option value="071">Floyd</option>
            <option value="073">Franklin</option>
            <option value="075">Fulton</option>
            <option value="077">Gallatin</option>
            <option value="079">Garrard</option>
            <option value="081">Grant</option>
            <option value="083">Graves</option>
            <option value="085">Grayson</option>
            <option value="087">Green</option>
            <option value="089">Greenup</option>
            <option value="091">Hancock</option>
            <option value="093">Hardin</option>
            <option value="095">Harlan</option>
            <option value="097">Harrison</option>
            <option value="099">Hart</option>
            <option value="101">Henderson</option>
            <option value="103">Henry</option>
            <option value="105">Hickman</option>
            <option value="107">Hopkins</option>
            <option value="109">Jackson</option>
            <option value="111">Jefferson</option>
            <option value="113">Jessamine</option>
            <option value="115">Johnson</option>
            <option value="117">Kenton</option>
            <option value="119">Knott</option>
            <option value="121">Knox</option>
            <option value="123">LaRue</option>
            <option value="125">Laurel</option>
            <option value="127">Lawrence</option>
            <option value="129">Lee</option>
            <option value="131">Leslie</option>
            <option value="133">Letcher</option>
            <option value="135">Lewis</option>
            <option value="137">Lincoln</option>
            <option value="139">Livingston</option>
            <option value="141">Logan</option>
            <option value="143">Lyon</option>
            <option value="145">McCracken</option>
            <option value="147">McCreary</option>
            <option value="149">McLean</option>
            <option value="151">Madison</option>
            <option value="153">Magoffin</option>
            <option value="155">Marion</option>
            <option value="157">Marshall</option>
            <option value="159">Martin</option>
            <option value="161">Mason</option>
            <option value="163">Meade</option>
            <option value="165">Menifee</option>
            <option value="167">Mercer</option>
            <option value="169">Metcalfe</option>
            <option value="171">Monroe</option>
            <option value="173">Montgomery</option>
            <option value="175">Morgan</option>
            <option value="177">Muhlenberg</option>
            <option value="179">Nelson</option>
            <option value="181">Nicholas</option>
            <option value="183">Ohio</option>
            <option value="185">Oldham</option>
            <option value="187">Owen</option>
            <option value="189">Owsley</option>
            <option value="191">Pendleton</option>
            <option value="193">Perry</option>
            <option value="195">Pike</option>
            <option value="197">Powell</option>
            <option value="199">Pulaski</option>
            <option value="201">Robertson</option>
            <option value="203">Rockcastle</option>
            <option value="205">Rowan</option>
            <option value="207">Russell</option>
            <option value="209">Scott</option>
            <option value="211">Shelby</option>
            <option value="213">Simpson</option>
            <option value="215">Spencer</option>
            <option value="217">Taylor</option>
            <option value="219">Todd</option>
            <option value="221">Trigg</option>
            <option value="223">Trimble</option>
            <option value="225">Union</option>
            <option value="227">Warren</option>
            <option value="229">Washington</option>
            <option value="231">Wayne</option>
            <option value="233">Webster</option>
            <option value="235">Whitley</option>
            <option value="237">Wolfe</option>
            <option value="239">Woodford</option>
          </select>

          <button class="button" id="calc" disabled>Calculate</button>
        </form>

        <div id="result" class="result" role="status" aria-live="polite">
          <h3 id="county-name">Results</h3>
          <p class="metric" id="pop">Population: <span>–</span></p>
          <p class="metric" id="green">Green space area: <span>–</span></p>
          <p class="metric" id="per">Sq ft per resident: <span>–</span></p>
          <p class="note">
            Data sources: Census ACS (population), OpenStreetMap (parks, later).
          </p>
        </div>

        <hr class="rule" />
        <footer>
          <small
            >Made in Kentucky by
            <a href="https://sleepingbear.us">Sleeping Bear Labs</a> • Method:
            OSM (parks) + Census ACS (population)</small
          >
        </footer>
      </section>
    </main>

    <!-- OSM JSON -> GeoJSON -->
    <script src="https://unpkg.com/osmtogeojson@3.0.0/osmtogeojson.js"></script>
    <!-- Turf for area calculation -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
      const county = document.getElementById("county");
      const calc = document.getElementById("calc");
      const result = document.getElementById("result");
      const countyName = document.getElementById("county-name");
      const popEl = document.getElementById("pop").querySelector("span");
      const greenEl = document.getElementById("green").querySelector("span");
      const perEl = document.getElementById("per").querySelector("span");

      county.addEventListener("change", () => {
        calc.disabled = !county.value;
      });

      // Fetch total PARKS area (sq ft) for a county using Overpass
      async function fetchParksAreaSqFt(countyName) {
        // simple + robust: look up the county area by name
        const ql = `
    [out:json][timeout:120];
    area["name"="${countyName} County"]["boundary"="administrative"]["admin_level"="6"]->.county;
    (
      way(area.county)["leisure"="park"];
      rel(area.county)["leisure"="park"];
    );
    out body;
    >;
    out skel qt;
  `.trim();

        // try two mirrors for reliability
        const endpoints = [
          "https://overpass.kumi.systems/api/interpreter",
          "https://overpass-api.de/api/interpreter",
        ];

        let lastErr;
        for (const url of endpoints) {
          try {
            const resp = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: "data=" + encodeURIComponent(ql),
            });
            if (!resp.ok) {
              lastErr = new Error("HTTP " + resp.status);
              continue;
            }

            const osmJson = await resp.json();
            const gj = osmtogeojson(osmJson);

            // polygon-only
            const polys = {
              type: "FeatureCollection",
              features: (gj.features || []).filter(
                (f) =>
                  f.geometry &&
                  (f.geometry.type === "Polygon" ||
                    f.geometry.type === "MultiPolygon")
              ),
            };

            const totalSqM = polys.features.reduce(
              (sum, f) => sum + turf.area(f),
              0
            );
            return totalSqM * 10.7639; // m² -> ft²
          } catch (e) {
            lastErr = e; // try next endpoint
          }
        }
        throw lastErr || new Error("Overpass failed");
      }

      // Placeholder for later — will fetch and compute green space area
      // Fetch total PARKS area (sq ft) inside a Kentucky county using Overpass
      // countyName should be plain (e.g., "Fayette", "Jefferson")
      async function fetchParksAreaSqFt(countyName) {
        // Overpass QL: find KY, then the county admin area, then all parks within it
        const ql = `
    [out:json][timeout:120];
    area["ISO3166-2"="US-KY"]->.ky;
    area.ky["boundary"="administrative"]["admin_level"="6"]["name"="${countyName} County"]->.county;
    (
      way(area.county)["leisure"="park"];
      rel(area.county)["leisure"="park"];
    );
    out body;
    >;
    out skel qt;
  `.trim();

        const resp = await fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "data=" + encodeURIComponent(ql),
        });
        if (!resp.ok) throw new Error("Overpass error " + resp.status);

        const osmJson = await resp.json();

        // Convert OSM JSON -> GeoJSON
        const gj = osmtogeojson(osmJson);

        // Keep only polygons
        const polys = {
          type: "FeatureCollection",
          features: gj.features.filter(
            (f) =>
              f.geometry &&
              (f.geometry.type === "Polygon" ||
                f.geometry.type === "MultiPolygon")
          ),
        };

        // Sum area (m²) and convert to ft²
        const totalSqM = polys.features.reduce(
          (sum, f) => sum + turf.area(f),
          0
        );
        const totalSqFt = totalSqM * 10.7639;

        // Return a plain number (can be 0 if no parks tagged)
        return totalSqFt;
      }

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!county.value) return;

        const name = county.options[county.selectedIndex].textContent;
        const fips = county.value;

        result.classList.add("show");
        countyName.textContent = name + " County";
        popEl.textContent = "…";
        greenEl.textContent = "loading…";
        perEl.textContent = "loading…";
        calc.disabled = true;

        try {
          // 1. Census population
          const url = `https://api.census.gov/data/2023/acs/acs5?get=NAME,B01003_001E&for=county:${fips}&in=state:21`;
          const resp = await fetch(url);
          const data = await resp.json();
          const pop = Number((data && data[1] && data[1][1]) || 0);
          popEl.textContent = new Intl.NumberFormat("en-US").format(pop);

          // 2 + 3. Parks area + per-resident calc
          try {
            const sqFt = await fetchParksAreaSqFt(name);
            greenEl.textContent = new Intl.NumberFormat("en-US", {
              maximumFractionDigits: 0,
            }).format(Math.round(sqFt));

            if (pop > 0) {
              const per = sqFt / pop;
              perEl.textContent = new Intl.NumberFormat("en-US", {
                maximumFractionDigits: 1,
              }).format(per);
            } else {
              perEl.textContent = "n/a";
            }
          } catch (e) {
            console.error(e);
            greenEl.textContent = "error";
            perEl.textContent = "error";
          }
        } catch (err) {
          console.error(err);
          popEl.textContent = "error";
        } finally {
          calc.disabled = false;
        }
      });
    </script>
  </body>
</html>
