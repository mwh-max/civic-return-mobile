<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Civic Return</title>
    <meta
      name="description"
      content="Find public park access signals in Kentucky."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f2e9;
        --bg-2: #e9dfc9;
        --ink: #21301f;
        --accent: #7f9b6a;
        --accent-ink: #f6f2e9;
        --card: #fffdf8;
        --muted: #65725f;
        --border: #e4ddcf;
        --focus: #3b6d3e;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Montserrat, system-ui, sans-serif;
        color: var(--ink);
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      }
      .container {
        max-width: 640px;
        margin: 0 auto;
        padding: 20px 16px 64px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px 20px;
        box-shadow: var(--shadow);
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 8px;
        justify-content: center;
        text-align: center;
      }
      .logo {
        width: 96px;
        height: 96px;
        border-radius: 12px;
        object-fit: contain;
        background: #e7e4d9;
      }
      .brand h1 {
        font-size: 28px;
        font-weight: 900;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .lead {
        text-align: center;
        margin: 12px 8px 24px;
      }
      .lead h2 {
        margin: 0 0 8px;
        font-size: 28px;
        line-height: 1.15;
        font-weight: 800;
      }
      .lead p {
        color: var(--muted);
        margin: 0;
      }
      .form {
        display: grid;
        gap: 14px;
        margin-top: 16px;
      }
      label {
        font-weight: 600;
      }
      select,
      button {
        width: 100%;
        font: inherit;
        border-radius: 12px;
        padding: 14px 12px;
        border: 1px solid var(--border);
        background: white;
      }
      select:focus,
      button:focus {
        outline: none;
        box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus) 35%, white);
        border-color: var(--focus);
      }
      .button {
        background: var(--accent);
        color: var(--accent-ink);
        border: none;
        font-weight: 700;
        letter-spacing: 0.3px;
        cursor: pointer;
      }
      .button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .rule {
        border: 0;
        height: 1px;
        background: var(--border);
        margin: 24px 0;
      }
      .result {
        display: none;
        margin-top: 12px;
        background: #f3f0e6;
        border: 1px dashed var(--border);
        padding: 16px;
        border-radius: 12px;
      }
      .result.show {
        display: block;
      }
      .result h3 {
        margin: 0 0 6px;
        font-size: 20px;
        font-weight: 800;
      }
      .metric {
        margin: 6px 0;
        font-size: 16px;
      }
      .metric span {
        font-weight: 800;
      }
      .note {
        color: var(--muted);
        font-size: 14px;
        margin-top: 8px;
      }
      .hidden {
        display: none;
      }
      footer {
        margin-top: 28px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card" aria-labelledby="title">
        <header>
          <img
            class="logo"
            src="assets/civic-return-logo.jpg"
            alt="Civic Return logo"
          />
          <div class="brand"><h1 id="title">CIVIC RETURN</h1></div>
        </header>

        <div class="lead">
          <h2>Find Parks & Access Signals</h2>
          <p>
            Select your Kentucky county to see park-site signals and per-capita
            access.
          </p>
        </div>

        <form class="form" id="form" novalidate>
          <label for="county">County</label>
          <select id="county" required>
            <option value="" selected>Select a countyâ€¦</option>
            <!-- full KY list intact (FIPS codes) -->
            <option value="001">Adair</option>
            <option value="003">Allen</option>
            <option value="005">Anderson</option>
            <option value="007">Ballard</option>
            <option value="009">Barren</option>
            <option value="011">Bath</option>
            <option value="013">Bell</option>
            <option value="015">Boone</option>
            <option value="017">Bourbon</option>
            <option value="019">Boyd</option>
            <option value="021">Boyle</option>
            <option value="023">Bracken</option>
            <option value="025">Breathitt</option>
            <option value="027">Breckinridge</option>
            <option value="029">Bullitt</option>
            <option value="031">Butler</option>
            <option value="033">Caldwell</option>
            <option value="035">Calloway</option>
            <option value="037">Campbell</option>
            <option value="039">Carlisle</option>
            <option value="041">Carroll</option>
            <option value="043">Carter</option>
            <option value="045">Casey</option>
            <option value="047">Christian</option>
            <option value="049">Clark</option>
            <option value="051">Clay</option>
            <option value="053">Clinton</option>
            <option value="055">Crittenden</option>
            <option value="057">Cumberland</option>
            <option value="059">Daviess</option>
            <option value="061">Edmonson</option>
            <option value="063">Elliott</option>
            <option value="065">Estill</option>
            <option value="067">Fayette</option>
            <option value="069">Fleming</option>
            <option value="071">Floyd</option>
            <option value="073">Franklin</option>
            <option value="075">Fulton</option>
            <option value="077">Gallatin</option>
            <option value="079">Garrard</option>
            <option value="081">Grant</option>
            <option value="083">Graves</option>
            <option value="085">Grayson</option>
            <option value="087">Green</option>
            <option value="089">Greenup</option>
            <option value="091">Hancock</option>
            <option value="093">Hardin</option>
            <option value="095">Harlan</option>
            <option value="097">Harrison</option>
            <option value="099">Hart</option>
            <option value="101">Henderson</option>
            <option value="103">Henry</option>
            <option value="105">Hickman</option>
            <option value="107">Hopkins</option>
            <option value="109">Jackson</option>
            <option value="111">Jefferson</option>
            <option value="113">Jessamine</option>
            <option value="115">Johnson</option>
            <option value="117">Kenton</option>
            <option value="119">Knott</option>
            <option value="121">Knox</option>
            <option value="123">LaRue</option>
            <option value="125">Laurel</option>
            <option value="127">Lawrence</option>
            <option value="129">Lee</option>
            <option value="131">Leslie</option>
            <option value="133">Letcher</option>
            <option value="135">Lewis</option>
            <option value="137">Lincoln</option>
            <option value="139">Livingston</option>
            <option value="141">Logan</option>
            <option value="143">Lyon</option>
            <option value="145">McCracken</option>
            <option value="147">McCreary</option>
            <option value="149">McLean</option>
            <option value="151">Madison</option>
            <option value="153">Magoffin</option>
            <option value="155">Marion</option>
            <option value="157">Marshall</option>
            <option value="159">Martin</option>
            <option value="161">Mason</option>
            <option value="163">Meade</option>
            <option value="165">Menifee</option>
            <option value="167">Mercer</option>
            <option value="169">Metcalfe</option>
            <option value="171">Monroe</option>
            <option value="173">Montgomery</option>
            <option value="175">Morgan</option>
            <option value="177">Muhlenberg</option>
            <option value="179">Nelson</option>
            <option value="181">Nicholas</option>
            <option value="183">Ohio</option>
            <option value="185">Oldham</option>
            <option value="187">Owen</option>
            <option value="189">Owsley</option>
            <option value="191">Pendleton</option>
            <option value="193">Perry</option>
            <option value="195">Pike</option>
            <option value="197">Powell</option>
            <option value="199">Pulaski</option>
            <option value="201">Robertson</option>
            <option value="203">Rockcastle</option>
            <option value="205">Rowan</option>
            <option value="207">Russell</option>
            <option value="209">Scott</option>
            <option value="211">Shelby</option>
            <option value="213">Simpson</option>
            <option value="215">Spencer</option>
            <option value="217">Taylor</option>
            <option value="219">Todd</option>
            <option value="221">Trigg</option>
            <option value="223">Trimble</option>
            <option value="225">Union</option>
            <option value="227">Warren</option>
            <option value="229">Washington</option>
            <option value="231">Wayne</option>
            <option value="233">Webster</option>
            <option value="235">Whitley</option>
            <option value="237">Wolfe</option>
            <option value="239">Woodford</option>
          </select>
          <button class="button" id="calc" type="submit" disabled>
            Calculate
          </button>
        </form>

        <div id="result" class="result" role="status" aria-live="polite">
          <h3 id="county-name">Results</h3>
          <p class="metric" id="pop">Population: <span>â€“</span></p>
          <p class="metric" id="parkcount">
            Mapped park sites (OSM): <span>â€“</span>
          </p>
          <p class="metric" id="npscount">
            National Park Service sites: <span>â€“</span>
          </p>

          <!-- New: Major parks touching county (NPS boundaries + KY State Parks) -->
          <p class="metric" id="majorparks">
            Major parks touching county (NPS + KY): <span>â€“</span>
          </p>
          <details id="majorparks-details" class="hidden">
            <summary>Show park names</summary>
            <ul id="majorparks-list" style="margin: 8px 0 0 18px"></ul>
          </details>

          <p class="metric" id="density">
            Park sites per 10k residents: <span>â€“</span>
          </p>
          <p id="note" class="note hidden"></p>
          <p class="note">
            Method: OSM leisure tags + NPS parks (KY only). Per-capita density
            uses ACS population. Small-population counties and OSM mapping gaps
            can skew density up or down.
          </p>
        </div>

        <hr class="rule" />
        <footer>
          <small
            >Made in Kentucky by
            <a href="https://sleepingbear.us">Sleeping Bear Labs</a></small
          >
        </footer>
      </section>
    </main>

    <script src="https://unpkg.com/osmtogeojson@2.2.13/osmtogeojson.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
      // ---- DOM
      const county = document.getElementById("county");
      const calc = document.getElementById("calc");
      const result = document.getElementById("result");
      const countyNameEl = document.getElementById("county-name");
      const popEl = document.getElementById("pop").querySelector("span");
      const parkCountEl = document
        .getElementById("parkcount")
        .querySelector("span");
      const npsCountEl = document
        .getElementById("npscount")
        .querySelector("span");
      const densityEl = document
        .getElementById("density")
        .querySelector("span");
      const noteEl = document.getElementById("note");

      // New DOM hooks
      const majorParksEl = document
        .getElementById("majorparks")
        .querySelector("span");
      const majorParksDetails = document.getElementById("majorparks-details");
      const majorParksList = document.getElementById("majorparks-list");

      const fmt0 = (n) =>
        new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(
          Math.round(n)
        );
      const fmt1 = (n) =>
        new Intl.NumberFormat("en-US", { maximumFractionDigits: 1 }).format(n);

      county.addEventListener("change", () => {
        calc.disabled = !county.value;
      });

      // --- NEW: ArcGIS constants + helpers (for boundary-based major parks)
      const LAYER_URL_NPS_BOUNDARIES =
        "https://services1.arcgis.com/fBc8EJBxQRMcHlei/ArcGIS/rest/services/NPS_Park_Boundaries/FeatureServer/0";
      const LAYER_URL_KY_STATE_PARKS =
        "https://services.arcgis.com/PwY9M7h4QWqZ4d8W/ArcGIS/rest/services/KY_State_Park_Boundaries/FeatureServer/0";

      const withTimeout = (ms, p) =>
        Promise.race([
          p,
          new Promise((_, r) => setTimeout(() => r(new Error("timeout")), ms)),
        ]);

      function geojsonToEsriRings(geo) {
        const toRings = (coords) =>
          coords.map((r) => r.map(([x, y]) => [x, y]));
        if (geo.type === "Polygon")
          return {
            rings: toRings(geo.coordinates),
            spatialReference: { wkid: 4326 },
          };
        if (geo.type === "MultiPolygon") {
          const rings = [];
          geo.coordinates.forEach((poly) =>
            poly.forEach((r) => rings.push(r.map(([x, y]) => [x, y])))
          );
          return { rings, spatialReference: { wkid: 4326 } };
        }
        throw new Error("Not a polygon");
      }

      async function queryArcGISIntersects(
        layerUrl,
        countyGeom,
        outFields = ["NAME", "PARK_NAME", "UNIT_NAME", "FULLNAME", "TYPE"]
      ) {
        const rings = geojsonToEsriRings(countyGeom);
        const params = new URLSearchParams({
          f: "geojson",
          where: "1=1",
          geometry: JSON.stringify(rings),
          geometryType: "esriGeometryPolygon",
          spatialRel: "esriSpatialRelIntersects",
          outFields: outFields.join(","),
          returnGeometry: "true",
          inSR: "4326",
          outSR: "4326",
        });
        const resp = await withTimeout(
          25000,
          fetch(`${layerUrl}/query?${params.toString()}`)
        );
        if (!resp.ok) throw new Error("ArcGIS query failed");
        return resp.json();
      }

      function parkNameFromProps(p = {}) {
        return (
          p.FULLNAME ||
          p.UNIT_NAME ||
          p.PARK_NAME ||
          p.NAME ||
          p.Name ||
          ""
        )
          .toString()
          .trim();
      }

      // --- Existing helpers
      async function fetchCountyGeoJSON(countyName) {
        const endpoints = [
          "https://overpass.kumi.systems/api/interpreter",
          "https://overpass-api.de/api/interpreter",
        ];

        // Use the Kentucky state area, then find the admin_level=6 county by name
        const ql = (name) => `
    [out:json][timeout:120];
    area["name"="Kentucky"]["boundary"="administrative"]["admin_level"="4"]->.ky;
    rel(area.ky)["boundary"="administrative"]["admin_level"="6"]["name"~"^${name}( County)?$"];
    out geom;
  `;

        for (const url of endpoints) {
          try {
            const resp = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: "data=" + encodeURIComponent(ql(countyName)),
            });
            if (!resp.ok) continue;

            const osm = await resp.json();
            const gj = osmtogeojson(osm);
            const polys = (gj.features || []).filter(
              (f) => f.geometry && /Polygon/.test(f.geometry.type)
            );
            if (polys.length) {
              // pick the largest polygon (handles multiparts)
              polys.sort((a, b) => turf.area(b) - turf.area(a));
              return polys[0].geometry;
            }
          } catch {}
        }
        throw new Error("County boundary not found");
      }

      async function fetchParksCount(countyName) {
        const endpoints = [
          "https://overpass.kumi.systems/api/interpreter",
          "https://overpass-api.de/api/interpreter",
        ];
        const areas = [
          `area["name"="${countyName} County"]["boundary"="administrative"]["admin_level"="6"]->.county;`,
          `area["name"="${countyName}"]["boundary"="administrative"]["admin_level"="6"]->.county;`,
        ];
        const include = `
          (
            node(area.county)["leisure"~"^(park|garden|recreation_ground|nature_reserve|village_green|common)$"]["leisure"!="golf_course"]["leisure"!="pitch"];
            way(area.county)["leisure"~"^(park|garden|recreation_ground|nature_reserve|village_green|common)$"]["leisure"!="golf_course"]["leisure"!="pitch"];
            rel(area.county)["leisure"~"^(park|garden|recreation_ground|nature_reserve|village_green|common)$"]["leisure"!="golf_course"]["leisure"!="pitch"];
          );`;
        for (const url of endpoints) {
          for (const a of areas) {
            const ql = `[out:json][timeout:120]; ${a} ${include} out tags;`;
            try {
              const r = await fetch(url, {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: "data=" + encodeURIComponent(ql),
              });
              if (!r.ok) continue;
              const json = await r.json();
              const els = json.elements || [];
              const byName = new Set(),
                byId = new Set();
              for (const e of els) {
                const name = ((e.tags && e.tags.name) || "")
                  .trim()
                  .toLowerCase();
                if (name) byName.add(name);
                else byId.add(`${e.type}:${e.id}`);
              }
              return byName.size + byId.size;
            } catch {}
          }
        }
        return 0;
      }

      async function fetchNpsParksInCounty(countyName) {
        const API_KEY = "nCK1ddXDcAzhGM8gEIaksAQRQ50n2zLEjcB5P5a4"; // your key
        const url = `https://developer.nps.gov/api/v1/parks?stateCode=KY&limit=600&fields=addresses,latLong&api_key=${API_KEY}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("NPS fetch failed");
        const data = await resp.json();
        const parks = Array.isArray(data.data) ? data.data : [];
        const countyGeom = await fetchCountyGeoJSON(countyName);
        const polygon = {
          type: "Feature",
          geometry: countyGeom,
          properties: {},
        };
        let count = 0;
        for (const p of parks) {
          const m = (p.latLong || "").match(
            /lat\s*:\s*([-+]?\d+(?:\.\d+)?)\s*,\s*long\s*:\s*([-+]?\d+(?:\.\d+)?)/i
          );
          if (!m) continue;
          const lat = parseFloat(m[1]),
            lon = parseFloat(m[2]);
          if (!isFinite(lat) || !isFinite(lon)) continue;
          const pt = turf.point([lon, lat]);
          if (turf.booleanPointInPolygon(pt, polygon)) count++;
        }
        return count;
      }

      // KY overrides to ensure cross-county NPS units appear
      const NPS_OVERRIDES_KY = {
        "Mammoth Cave National Park": ["Barren", "Edmonson", "Hart"],
        "Cumberland Gap National Historical Park": ["Bell", "Harlan"],
        "Big South Fork National River and Recreation Area": [
          "McCreary",
          "Wayne",
        ],
        "Abraham Lincoln Birthplace National Historical Park": ["LaRue"],
        "Camp Nelson National Monument": ["Jessamine"],
        "Mill Springs Battlefield National Monument": ["Pulaski", "Wayne"],
        "Fort Donelson National Battlefield": ["Calloway"], // Fort Heiman unit on KY side
      };

      async function fetchMajorParksTouchingCounty(countyName) {
        const countyGeom = await fetchCountyGeoJSON(countyName);
        const names = new Set();

        // 1) NPS boundary polygons
        try {
          if (LAYER_URL_NPS_BOUNDARIES) {
            const gj = await queryArcGISIntersects(
              LAYER_URL_NPS_BOUNDARIES,
              countyGeom,
              ["FULLNAME", "UNIT_CODE"]
            );
            for (const f of gj.features || []) {
              const nm = parkNameFromProps(f.properties);
              if (nm) names.add(nm);
            }
          }
        } catch {}

        // 2) KY State Park boundaries
        try {
          if (LAYER_URL_KY_STATE_PARKS) {
            const gj = await queryArcGISIntersects(
              LAYER_URL_KY_STATE_PARKS,
              countyGeom,
              ["PARK_NAME", "TYPE"]
            );
            for (const f of gj.features || []) {
              const nm = parkNameFromProps(f.properties);
              if (nm) names.add(nm + " (State Park)");
            }
          }
        } catch {}

        // 3) Overrides (guarantee key NPS units by county)
        for (const [park, counties] of Object.entries(NPS_OVERRIDES_KY)) {
          if (counties.includes(countyName)) names.add(park);
        }

        return Array.from(names).sort((a, b) => a.localeCompare(b));
      }

      // ---- Submit
      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!county.value) return;

        const name = county.options[county.selectedIndex].textContent;
        const fips = county.value;

        result.classList.add("show");
        countyNameEl.textContent = name + " County";
        popEl.textContent = "â€¦";
        parkCountEl.textContent = "loadingâ€¦";
        npsCountEl.textContent = "loadingâ€¦";
        densityEl.textContent = "loadingâ€¦";
        noteEl.classList.add("hidden");

        // reset major parks UI
        majorParksEl.textContent = "loadingâ€¦";
        majorParksDetails.classList.add("hidden");
        majorParksList.innerHTML = "";

        calc.disabled = true;

        let popNum = 0,
          sites = 0;

        // Population (ACS 2023)
        try {
          const url = `https://api.census.gov/data/2023/acs/acs5?get=NAME,B01003_001E&for=county:${fips}&in=state:21`;
          const resp = await fetch(url);
          const data = await resp.json();
          popNum = Number((data && data[1] && data[1][1]) || 0);
          popEl.textContent = new Intl.NumberFormat("en-US").format(popNum);
        } catch {
          popEl.textContent = "â€”";
        }

        // OSM mapped park sites (count)
        try {
          sites = await fetchParksCount(name);
          parkCountEl.textContent = new Intl.NumberFormat("en-US").format(
            sites
          );
        } catch {
          parkCountEl.textContent = "â€”";
        }

        // NPS sites (point-in-polygon)
        try {
          const npsCount = await fetchNpsParksInCounty(name);
          npsCountEl.textContent = new Intl.NumberFormat("en-US").format(
            npsCount
          );
        } catch {
          npsCountEl.textContent = "â€”";
        }

        // Density (always computable when pop > 0)
        if (popNum > 0) {
          densityEl.textContent = ((sites / popNum) * 10000).toFixed(1);
          if (popNum < 5000) {
            noteEl.textContent =
              "Per-capita density can swing in small-population counties.";
            noteEl.classList.remove("hidden");
          }
        } else {
          densityEl.textContent = "â€”";
          noteEl.textContent =
            "Population not available from ACS for this county right now.";
          noteEl.classList.remove("hidden");
        }

        // NEW: Major parks by county overlap (NPS boundaries + KY State Parks + overrides)
        try {
          const parks = await fetchMajorParksTouchingCounty(name);
          majorParksEl.textContent = new Intl.NumberFormat("en-US").format(
            parks.length
          );
          if (parks.length) {
            majorParksDetails.classList.remove("hidden");
            majorParksList.innerHTML = parks
              .map(
                (n) =>
                  `<li>${n.replace(/&/g, "&amp;").replace(/</g, "&lt;")}</li>`
              )
              .join("");
          } else {
            majorParksDetails.classList.add("hidden");
          }
        } catch {
          majorParksEl.textContent = "â€”";
          majorParksDetails.classList.add("hidden");
        }

        calc.disabled = false;
      });
    </script>
  </body>
</html>
